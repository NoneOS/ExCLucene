/*************************************************************************
	> File: Simple16.h
	> Author: Naiyong Ao
	> Email: aonaiyong@gmail.com 
	> Time: Sun 01 Feb 2015 07:16:56 PM CST
 ************************************************************************/

#ifndef SIMPLE16_H_
#define SIMPLE16_H_

#include <stdint.h>

inline void s16_encode(uint32_t *&out, uint32_t *&in, uint32_t nvalue) { 
	uint32_t cnum[16] = {28, 21, 21, 21, 14, 9, 8, 7, 6, 6, 5, 5, 4, 3, 2, 1};

	uint32_t cbits[16][28] = { 
		{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
		{2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0},
		{1,1,1,1,1,1,1,2,2,2,2,2,2,2,1,1,1,1,1,1,1,0,0,0,0,0,0,0},
		{1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,0,0,0,0,0,0,0},
		{2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{4,3,3,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{3,4,4,4,4,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{5,5,5,5,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{4,4,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{6,6,6,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{5,5,6,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{10,9,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{28,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
	};


	for (uint32_t k = 0; k < 16; ++k) { 
		out[0] = k << 28; 		

		uint32_t vol = (cnum[k] < nvalue) ? cnum[k] : nvalue; 
		uint32_t shift = 0;
		uint32_t j = 0;
		for (j = 0; (j < vol) && (in[j] < (1U << cbits[k][j])); ++j) { 
			out[0] += in[j] << shift; 
			shift += cbits[k][j]; 
		} 

		if (j == vol) { 
			in += vol; 
			++out; 

			break; 
		} 
	} 
}


/* more optimized handcoded edition */
#define S16_DECODE(w, p)	\
{ \
  uint32_t k = (*w)>>28; \
  switch(k) \
  { \
    case 0: \
      *p = (*w) & 1;     p++; \
      *p = (*w>>1) & 1;  p++; \
      *p = (*w>>2) & 1;  p++; \
      *p = (*w>>3) & 1;  p++; \
      *p = (*w>>4) & 1;  p++; \
      *p = (*w>>5) & 1;  p++; \
      *p = (*w>>6) & 1;  p++; \
      *p = (*w>>7) & 1;  p++; \
      *p = (*w>>8) & 1;  p++; \
      *p = (*w>>9) & 1;  p++; \
      *p = (*w>>10) & 1;  p++; \
      *p = (*w>>11) & 1;  p++; \
      *p = (*w>>12) & 1;  p++; \
      *p = (*w>>13) & 1;  p++; \
      *p = (*w>>14) & 1;  p++; \
      *p = (*w>>15) & 1;  p++; \
      *p = (*w>>16) & 1;  p++; \
      *p = (*w>>17) & 1;  p++; \
      *p = (*w>>18) & 1;  p++; \
      *p = (*w>>19) & 1;  p++; \
      *p = (*w>>20) & 1;  p++; \
      *p = (*w>>21) & 1;  p++; \
      *p = (*w>>22) & 1;  p++; \
      *p = (*w>>23) & 1;  p++; \
      *p = (*w>>24) & 1;  p++; \
      *p = (*w>>25) & 1;  p++; \
      *p = (*w>>26) & 1;  p++; \
      *p = (*w>>27) & 1;  p++; \
      break; \
    case 1: \
      *p = (*w) & 3;     p++; \
      *p = (*w>>2) & 3;  p++; \
      *p = (*w>>4) & 3;  p++; \
      *p = (*w>>6) & 3;  p++; \
      *p = (*w>>8) & 3;  p++; \
      *p = (*w>>10) & 3;  p++; \
      *p = (*w>>12) & 3;  p++; \
      *p = (*w>>14) & 1;  p++; \
      *p = (*w>>15) & 1;  p++; \
      *p = (*w>>16) & 1;  p++; \
      *p = (*w>>17) & 1;  p++; \
      *p = (*w>>18) & 1;  p++; \
      *p = (*w>>19) & 1;  p++; \
      *p = (*w>>20) & 1;  p++; \
      *p = (*w>>21) & 1;  p++; \
      *p = (*w>>22) & 1;  p++; \
      *p = (*w>>23) & 1;  p++; \
      *p = (*w>>24) & 1;  p++; \
      *p = (*w>>25) & 1;  p++; \
      *p = (*w>>26) & 1;  p++; \
      *p = (*w>>27) & 1;  p++; \
      break; \
    case 2: \
      *p = (*w) & 1;     p++; \
      *p = (*w>>1) & 1;  p++; \
      *p = (*w>>2) & 1;  p++; \
      *p = (*w>>3) & 1;  p++; \
      *p = (*w>>4) & 1;  p++; \
      *p = (*w>>5) & 1;  p++; \
      *p = (*w>>6) & 1;  p++; \
      *p = (*w>>7) & 3;  p++; \
      *p = (*w>>9) & 3;  p++; \
      *p = (*w>>11) & 3;  p++; \
      *p = (*w>>13) & 3;  p++; \
      *p = (*w>>15) & 3;  p++; \
      *p = (*w>>17) & 3;  p++; \
      *p = (*w>>19) & 3;  p++; \
      *p = (*w>>21) & 1;  p++; \
      *p = (*w>>22) & 1;  p++; \
      *p = (*w>>23) & 1;  p++; \
      *p = (*w>>24) & 1;  p++; \
      *p = (*w>>25) & 1;  p++; \
      *p = (*w>>26) & 1;  p++; \
      *p = (*w>>27) & 1;  p++; \
      break; \
    case 3: \
      *p = (*w) & 1;     p++; \
      *p = (*w>>1) & 1;  p++; \
      *p = (*w>>2) & 1;  p++; \
      *p = (*w>>3) & 1;  p++; \
      *p = (*w>>4) & 1;  p++; \
      *p = (*w>>5) & 1;  p++; \
      *p = (*w>>6) & 1;  p++; \
      *p = (*w>>7) & 1;  p++; \
      *p = (*w>>8) & 1;  p++; \
      *p = (*w>>9) & 1;  p++; \
      *p = (*w>>10) & 1;  p++; \
      *p = (*w>>11) & 1;  p++; \
      *p = (*w>>12) & 1;  p++; \
      *p = (*w>>13) & 1;  p++; \
      *p = (*w>>14) & 3;  p++; \
      *p = (*w>>16) & 3;  p++; \
      *p = (*w>>18) & 3;  p++; \
      *p = (*w>>20) & 3;  p++; \
      *p = (*w>>22) & 3;  p++; \
      *p = (*w>>24) & 3;  p++; \
      *p = (*w>>26) & 3;  p++; \
      break; \
    case 4: \
      *p = (*w) & 3;     p++; \
      *p = (*w>>2) & 3;  p++; \
      *p = (*w>>4) & 3;  p++; \
      *p = (*w>>6) & 3;  p++; \
      *p = (*w>>8) & 3;  p++; \
      *p = (*w>>10) & 3;  p++; \
      *p = (*w>>12) & 3;  p++; \
      *p = (*w>>14) & 3;  p++; \
      *p = (*w>>16) & 3;  p++; \
      *p = (*w>>18) & 3;  p++; \
      *p = (*w>>20) & 3;  p++; \
      *p = (*w>>22) & 3;  p++; \
      *p = (*w>>24) & 3;  p++; \
      *p = (*w>>26) & 3;  p++; \
      break; \
    case 5: \
      *p = (*w) & 15;     p++; \
      *p = (*w>>4) & 7;  p++; \
      *p = (*w>>7) & 7;  p++; \
      *p = (*w>>10) & 7;  p++; \
      *p = (*w>>13) & 7;  p++; \
      *p = (*w>>16) & 7;  p++; \
      *p = (*w>>19) & 7;  p++; \
      *p = (*w>>22) & 7;  p++; \
      *p = (*w>>25) & 7;  p++; \
      break; \
    case 6: \
      *p = (*w) & 7;     p++; \
      *p = (*w>>3) & 15;  p++; \
      *p = (*w>>7) & 15;  p++; \
      *p = (*w>>11) & 15;  p++; \
      *p = (*w>>15) & 15;  p++; \
      *p = (*w>>19) & 7;  p++; \
      *p = (*w>>22) & 7;  p++; \
      *p = (*w>>25) & 7;  p++; \
      break; \
    case 7: \
      *p = (*w) & 15;     p++; \
      *p = (*w>>4) & 15;  p++; \
      *p = (*w>>8) & 15;  p++; \
      *p = (*w>>12) & 15;  p++; \
      *p = (*w>>16) & 15;  p++; \
      *p = (*w>>20) & 15;  p++; \
      *p = (*w>>24) & 15;  p++; \
      break; \
    case 8: \
      *p = (*w) & 31;     p++; \
      *p = (*w>>5) & 31;  p++; \
      *p = (*w>>10) & 31;  p++; \
      *p = (*w>>15) & 31;  p++; \
      *p = (*w>>20) & 15;  p++; \
      *p = (*w>>24) & 15;  p++; \
      break; \
    case 9: \
      *p = (*w) & 15;     p++; \
      *p = (*w>>4) & 15;  p++; \
      *p = (*w>>8) & 31;  p++; \
      *p = (*w>>13) & 31;  p++; \
      *p = (*w>>18) & 31;  p++; \
      *p = (*w>>23) & 31;  p++; \
      break; \
    case 10: \
      *p = (*w) & 63;     p++; \
      *p = (*w>>6) & 63;  p++; \
      *p = (*w>>12) & 63;  p++; \
      *p = (*w>>18) & 31;  p++; \
      *p = (*w>>23) & 31;  p++; \
      break; \
    case 11: \
      *p = (*w) & 31;     p++; \
      *p = (*w>>5) & 31;  p++; \
      *p = (*w>>10) & 63;  p++; \
      *p = (*w>>16) & 63;  p++; \
      *p = (*w>>22) & 63;  p++; \
      break; \
    case 12: \
      *p = (*w) & 127;     p++; \
      *p = (*w>>7) & 127;  p++; \
      *p = (*w>>14) & 127;  p++; \
      *p = (*w>>21) & 127;  p++; \
      break; \
    case 13: \
      *p = (*w) & 1023;     p++; \
      *p = (*w>>10) & 511;  p++; \
      *p = (*w>>19) & 511;  p++; \
      break; \
    case 14: \
      *p = (*w) & 16383;     p++; \
      *p = (*w>>14) & 16383;  p++; \
      break; \
    case 15: \
      *p = (*w) & ((1<<28)-1);     p++; \
      break; \
  }\
  w++; \
}

#endif /* SIMPLE16_H_ */
